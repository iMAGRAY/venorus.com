# Настройка системы тегов товаров

## Обзор

Система тегов позволяет выделять особенности товаров с помощью визуальных меток. Теги помогают привлечь внимание к акциям, новинкам, эксклюзивным предложениям и другим важным характеристикам товаров.

## Быстрый старт

1. Перейдите в админку: `/admin`
2. Откройте раздел "Теги" в меню слева
3. Проверьте список доступных тегов (10 тегов уже созданы)
4. Чтобы добавить теги к товару:
   - Перейдите в раздел "Товары"
   - Выберите товар для редактирования
   - Откройте вкладку "Теги"
   - Отметьте нужные теги галочками
   - Теги сохранятся автоматически

## Структура базы данных

### Требования

- PostgreSQL база данных
- Переменная окружения `DATABASE_URL` или отдельные переменные подключения
- Таблица `products` с полем `id` типа integer
- Таблица `product_variants` с полем `id` типа integer

### Таблицы

1. **product_tags** - основная таблица тегов
   - `id` - уникальный идентификатор
   - `name` - название тега (например, "Новинка")
   - `slug` - URL-совместимый идентификатор (например, "new")
   - `color` - цвет текста в формате HEX
   - `bg_color` - цвет фона в формате HEX
   - `icon` - название иконки из библиотеки Lucide
   - `is_active` - активность тега
   - `sort_order` - порядок сортировки
   - `product_id` - ID товара для личных тегов товара (NULL для общих)
   - `variant_id` - ID варианта для личных тегов варианта (NULL для общих)
   - `created_at`, `updated_at` - временные метки
   
   **Типы тегов:**
   - Общие теги: `product_id = NULL` и `variant_id = NULL`
   - Личные теги товара: `product_id = ID` и `variant_id = NULL`
   - Личные теги варианта: `product_id = NULL` и `variant_id = ID`

2. **product_tag_relations** - связь товаров с тегами
   - `id` - уникальный идентификатор
   - `product_id` - ID товара (integer)
   - `tag_id` - ID тега
   - `created_at` - дата создания связи

3. **variant_tag_relations** - связь вариантов товаров с тегами
   - `id` - уникальный идентификатор
   - `variant_id` - ID варианта товара (integer)
   - `tag_id` - ID тега
   - `created_at` - дата создания связи

## Начальные теги

При установке создаются следующие теги:

1. **Новинка** - для новых товаров
2. **Хит продаж** - для популярных товаров
3. **Рекомендуем** - для рекомендованных товаров
4. **Акция** - для товаров со скидкой
5. **Эксклюзив** - для эксклюзивных товаров
6. **Премиум** - для премиальных товаров
7. **Экологичный** - для экологичных товаров
8. **Гарантия 5 лет** - для товаров с расширенной гарантией
9. **Быстрая доставка** - для товаров с быстрой доставкой
10. **Сделано в России** - для отечественных товаров

## API Endpoints

### Управление тегами

- `GET /api/product-tags` - получить все общие теги
- `GET /api/product-tags?product_id={id}` - получить общие теги + личные теги товара
- `GET /api/product-tags?variant_id={id}` - получить общие теги + личные теги варианта
- `POST /api/product-tags` - создать новый тег
  - Без `product_id` и `variant_id` - создается общий тег
  - С `product_id` - создается личный тег для конкретного товара
  - С `variant_id` - создается личный тег для конкретного варианта
- `PUT /api/product-tags` - обновить тег
- `DELETE /api/product-tags?id={id}` - удалить тег

### Теги товаров

- `GET /api/products/{id}/tags` - получить теги товара
- `POST /api/products/{id}/tags` - добавить тег к товару
- `PUT /api/products/{id}/tags` - заменить все теги товара
- `DELETE /api/products/{id}/tags?tag_id={id}` - удалить тег у товара

### Теги вариантов

- `GET /api/variants/{id}/tags` - получить теги варианта (общие + личные)
- `POST /api/variants/{id}/tags` - добавить общий тег к варианту
- `PUT /api/variants/{id}/tags` - заменить все теги варианта
- `DELETE /api/variants/{id}/tags?tag_id={id}` - удалить общий тег у варианта
- `DELETE /api/variants/{id}/personal-tags/{tagId}` - удалить личный тег варианта

## Административный интерфейс

### Страница управления тегами

Доступна по адресу `/admin/tags`

Функции:
- Создание новых тегов
- Редактирование существующих тегов
- Настройка цветов и иконок
- Управление порядком отображения
- Активация/деактивация тегов

### Редактирование товара

В форме редактирования товара добавлена вкладка "Теги", где можно:

#### Общие возможности:
- Просматривать текущие теги товара  
- Добавлять/удалять общие теги
- Видеть количество личных тегов в заголовке

#### Работа с личными тегами:
- **Кнопка "Создать личный тег"** в правом верхнем углу
- Личные теги отображаются в отдельной секции с заголовком "Личные теги (только для этого товара)"
- Фоновая подсветка для визуального отличия от общих тегов
- Иконка пользователя в каждом личном теге
- **Кнопка удаления** (корзина) появляется при наведении на личный тег
- Подсказка с примерами использования, если нет личных тегов

#### Создание личного тега:
- Диалог с формой создания
- Настройка названия, цветов, иконки
- Автоматическая генерация URL из названия
- Предпросмотр тега перед созданием
- Автоматическая привязка к текущему товару

### Редактирование варианта товара

В форме редактирования варианта добавлена вкладка "Теги", где можно:

#### Общие возможности:
- Просматривать текущие теги варианта
- Добавлять/удалять общие теги
- Видеть количество личных тегов в заголовке

#### Работа с личными тегами варианта:
- **Кнопка "Создать личный тег"** в правом верхнем углу
- Личные теги отображаются в отдельной секции
- Фоновая подсветка для визуального отличия
- Иконка пользователя в каждом личном теге
- **Кнопка удаления** (корзина) при наведении
- Подсказка с примерами для вариантов (размеры, цвета, особенности)

#### Примеры личных тегов варианта:
- "Размер XXL", "Детский размер"
- "Синий металлик", "Красный матовый"
- "Усиленная конструкция", "Облегченная версия"

#### Отображение:
- Теги варианта отображаются вместе с тегами основного товара
- При выборе варианта на странице товара показываются объединенные теги

## Отображение тегов

Теги отображаются:
- На карточках товаров в каталоге
- На странице товара под названием
- В списке товаров

## Компоненты

### ProductTagsDisplay

Компонент для отображения тегов товара и варианта с возможностью раскрытия всех тегов.

```tsx
<ProductTagsDisplay 
  productId={123}
  variantId={456} // опционально - ID варианта
  variant="default" // или "compact"
  maxTags={5} // максимальное количество отображаемых тегов по умолчанию
  className="mb-2"
/>
```

**Функции:**
- Отображает до `maxTags` тегов (по умолчанию 3)
- Объединяет теги товара и варианта (если указан variantId)
- При наличии большего количества тегов показывает кнопку "+N" с количеством скрытых тегов
- При клике на "+N" раскрываются все теги
- При раскрытых тегах показывается кнопка "Свернуть"
- Анимированное раскрытие/сворачивание тегов
- Автоматически удаляет дубликаты тегов

### ProductTagsSelector

Компонент для выбора тегов товара в админке.

```tsx
<ProductTagsSelector 
  productId={123}
  onChange={(tags) => console.log(tags)}
/>
```

### VariantTagsSelector

Компонент для выбора тегов варианта товара в админке.

```tsx
<VariantTagsSelector 
  variantId={456}
  onChange={(tags) => console.log(tags)}
  className="w-full"
/>
```

**Функции:**
- Отображает все доступные теги с чекбоксами
- Автоматически сохраняет изменения при выборе/снятии тега
- Показывает выбранные теги в виде badges
- Поддерживает загрузочное состояние

## Настройка цветов и иконок

При создании или редактировании тега можно настроить:
- **Цвет текста** - любой цвет в формате HEX
- **Цвет фона** - должен гармонировать с цветом текста
- **Иконка** - выбор из предустановленных иконок Lucide

## Рекомендации по использованию

1. **Оптимальное количество тегов** - рекомендуется 3-7 тегов на товар для лучшей информативности
2. **Используйте контрастные цвета** - текст должен хорошо читаться на фоне
3. **Следите за актуальностью** - удаляйте устаревшие теги (например, "Новинка" для старых товаров)
4. **Группируйте по смыслу** - используйте sort_order для логичной группировки тегов
5. **Настройка отображения**:
   - На странице товара показывается до 5 тегов с возможностью раскрытия остальных
   - На карточках товаров в каталоге - до 3 тегов (компактный вид)
   - В списке товаров - до 4 тегов
6. **Личные теги**:
   - Используйте для уникальных акций конкретного товара ("Последний экземпляр", "Только сегодня -50%")
   - Не создавайте личные теги для информации, подходящей многим товарам
   - Личные теги автоматически удаляются при удалении товара
   - Максимально информативные названия для быстрого понимания
7. **Теги вариантов**:
   - Используйте теги вариантов для выделения особенностей конкретных модификаций
   - Теги варианта отображаются вместе с тегами основного товара
   - Избегайте дублирования тегов между товаром и вариантом
   - Примеры тегов для вариантов: "Увеличенная батарея", "Облегченная версия", "Усиленная конструкция"

## Примеры использования

### Добавление тега к товару через API

```javascript
const response = await fetch('/api/products/123/tags', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  credentials: 'include',
  body: JSON.stringify({
    tag_id: 1 // ID тега "Новинка"
  })
});
```

### Добавление тега к варианту через API

```javascript
const response = await fetch('/api/variants/456/tags', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  credentials: 'include',
  body: JSON.stringify({
    tag_id: 2 // ID тега "Хит продаж"
  })
});
```

### Создание нового тега

```javascript
const response = await fetch('/api/product-tags', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  credentials: 'include',
  body: JSON.stringify({
    name: 'Ограниченная серия',
    slug: 'limited-edition',
    color: '#dc2626',
    bg_color: '#fee2e2',
    icon: 'clock',
    is_active: true,
    sort_order: 45
  })
});
```

### Создание личного тега для товара

При редактировании товара можно создать личный тег прямо из формы:

1. Откройте вкладку "Теги" в форме товара
2. Нажмите кнопку "Создать тег"
3. Заполните форму:
   - **Название** - обязательное поле (например, "Только сегодня -30%")
   - **URL** - необязательное поле (автоматически генерируется из названия)
   - **Цвет текста** и **Цвет фона** - выберите с помощью color picker
   - **Иконка** - выберите из списка доступных
4. Посмотрите предпросмотр тега
5. Нажмите "Создать"

Созданный личный тег:
- Автоматически привязан к текущему товару
- Не отображается в списке тегов других товаров
- Можно создавать с одинаковым названием для разных товаров

## Создание таблиц в БД

### Поддержка личных тегов

Для добавления поддержки личных тегов выполните миграцию:

```sql
-- Добавляем поле product_id для личных тегов товаров
ALTER TABLE product_tags 
ADD COLUMN IF NOT EXISTS product_id INTEGER DEFAULT NULL;

-- Добавляем поле variant_id для личных тегов вариантов
ALTER TABLE product_tags 
ADD COLUMN IF NOT EXISTS variant_id INTEGER DEFAULT NULL;

-- Создаем индексы для быстрого поиска
CREATE INDEX IF NOT EXISTS idx_product_tags_product_id ON product_tags(product_id);
CREATE INDEX IF NOT EXISTS idx_product_tags_variant_id ON product_tags(variant_id);

-- Убираем старые уникальные ограничения
ALTER TABLE product_tags DROP CONSTRAINT IF EXISTS product_tags_name_key;
ALTER TABLE product_tags DROP CONSTRAINT IF EXISTS product_tags_slug_key;

-- Добавляем составные уникальные индексы для товаров
CREATE UNIQUE INDEX IF NOT EXISTS idx_product_tags_name_product_id ON product_tags(name, product_id);
CREATE UNIQUE INDEX IF NOT EXISTS idx_product_tags_slug_product_id ON product_tags(slug, product_id);

-- Добавляем составные уникальные индексы для вариантов
CREATE UNIQUE INDEX IF NOT EXISTS idx_product_tags_name_variant_id ON product_tags(name, variant_id);
CREATE UNIQUE INDEX IF NOT EXISTS idx_product_tags_slug_variant_id ON product_tags(slug, variant_id);

-- Комментарии
COMMENT ON COLUMN product_tags.product_id IS 'ID товара для личных тегов. NULL для общих тегов';
COMMENT ON COLUMN product_tags.variant_id IS 'ID варианта для личных тегов вариантов. NULL для общих тегов';
```

### Создание таблицы для тегов вариантов

Если таблица `variant_tag_relations` не существует, выполните следующий SQL:

```sql
CREATE TABLE IF NOT EXISTS variant_tag_relations (
  id SERIAL PRIMARY KEY,
  variant_id INTEGER NOT NULL,
  tag_id INTEGER NOT NULL REFERENCES product_tags(id) ON DELETE CASCADE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(variant_id, tag_id)
);

CREATE INDEX IF NOT EXISTS idx_variant_tag_relations_variant_id ON variant_tag_relations(variant_id);
CREATE INDEX IF NOT EXISTS idx_variant_tag_relations_tag_id ON variant_tag_relations(tag_id);
```

## Устранение неполадок

### Ошибка 500 при загрузке тегов

**Причина**: Неправильный импорт pool в API endpoints.

**Решение**: Убедитесь, что в файлах API используется правильный импорт:
```typescript
import { pool } from '@/lib/db' // Правильно
// НЕ import pool from '@/lib/db'
```

### Ошибка 403 Forbidden при управлении тегами

**Причина 1**: Cookies с авторизацией администратора не передаются в API запросах.

**Решение 1**: Добавьте `credentials: 'include'` во все fetch запросы:
```javascript
const response = await fetch('/api/product-tags', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  credentials: 'include', // Важно!
  body: JSON.stringify(data)
})
```

**Причина 2**: Неправильное имя cookie для проверки авторизации в API.

**Решение 2**: Используйте правильное имя cookie сессии:
```typescript
// Вместо:
const isAdmin = cookieStore.get('adminAuth')?.value === 'true'

// Используйте:
const sessionId = cookieStore.get('admin_session')?.value
const isAdmin = !!sessionId
```

### Теги не отображаются на товарах

**Причина**: Товары не связаны с тегами.

**Решение**: 
1. Перейдите в админку → Товары
2. Выберите товар для редактирования
3. Откройте вкладку "Теги"
4. Отметьте нужные теги

### Ошибка подключения к БД

**Причина**: Неправильные настройки подключения.

**Решение**: 
1. Проверьте переменную `DATABASE_URL` в файле `.env`
2. Убедитесь, что пароль правильно экранирован (`@` → `%40`)
3. Проверьте настройки SSL подключения