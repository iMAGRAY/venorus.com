# Отчет об очистке базы данных

Дата: 02.08.2025

## Результаты анализа

### Обнаружено для очистки:
1. **Осиротевшие медиафайлы**: 114 записей
   - Файлы, не привязанные ни к одному товару или варианту
   
2. **Неиспользуемые значения характеристик**: 188 записей
   - Значения характеристик, не привязанные ни к одному товару

3. **Legacy/backup таблицы**: 5 таблиц
   - characteristic_templates
   - characteristics_consolidated_backup
   - eav_backup_before_cleanup
   - form_templates
   - product_characteristics_new_backup_final

### Текущее состояние БД:
- Размер: 18 MB
- Всего таблиц: 69
- Активных товаров: 35
- Вариантов товаров: 33

## Созданные скрипты

### 1. `scripts/cleanup/cleanup-obsolete-data.js`
Основной скрипт очистки с поддержкой:
- Режим dry-run для предварительной проверки
- Транзакционная безопасность
- Автоматическая оптимизация БД после очистки (VACUUM ANALYZE)

### 2. `scripts/cleanup/backup-before-cleanup.js`
Скрипт создания резервной копии:
- Сохраняет только затрагиваемые таблицы
- Создает метаданные и скрипт восстановления
- Резервные копии сохраняются в папку `backups/`

### 3. `scripts/cleanup/README.md`
Документация по использованию скриптов

## Рекомендации

### Для немедленного выполнения:
1. **Создать резервную копию**:
   ```bash
   node scripts/cleanup/backup-before-cleanup.js
   ```

2. **Выполнить очистку** (после резервного копирования):
   ```bash
   node scripts/cleanup/cleanup-obsolete-data.js
   ```

### Для дальнейшего рассмотрения:
1. **Legacy таблицы** - проверить вручную и удалить если не нужны:
   ```sql
   DROP TABLE IF EXISTS characteristic_templates;
   DROP TABLE IF EXISTS characteristics_consolidated_backup;
   DROP TABLE IF EXISTS eav_backup_before_cleanup;
   DROP TABLE IF EXISTS form_templates;
   DROP TABLE IF EXISTS product_characteristics_new_backup_final;
   ```

2. **Регулярная очистка** - настроить cron job для автоматической очистки:
   - Старых сессий (ежедневно)
   - Осиротевших данных (еженедельно)

3. **Оптимизация хранения изображений**:
   - Таблицы product_images и variant_images пусты
   - Рассмотреть миграцию всех изображений в JSONB поля
   - Или наоборот - использовать реляционные таблицы

## Безопасность

- Все скрипты используют транзакции
- Dry-run режим по умолчанию для проверки
- Автоматическое создание скриптов восстановления
- Логирование всех операций

## Следующие шаги

1. Выполнить резервное копирование и очистку
2. Проверить работу приложения после очистки
3. Рассмотреть удаление legacy таблиц
4. Настроить регулярную автоматическую очистку