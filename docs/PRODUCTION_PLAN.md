# План приведения проекта в продакшен-состояние

## 0. Резервное копирование БД
- Подготовить окружение: заполнить `.env.local` или `database.env`
- Выполнить полный бэкап БД:
  - `node scripts/database/backup-full.js`
  - Проверить наличие артефактов в `database/backups/`

## 1. Базовая диагностика проекта
- Установить зависимости: `npm ci`
- Проверить сборку: `npm run build`
- Запустить линтер: `npm run lint`
- Запустить тип-проверку: `npm run type-check`
- Запустить тесты: `node tests/run-all-tests.js`

## 2. Конфигурация окружения
- Верифицировать обязательные переменные для БД: `DATABASE_URL` или `POSTGRESQL_*`
- Redis: `REDIS_HOST`, `REDIS_PORT`, `REDIS_PASSWORD` (если требуется)
- S3: `S3_ENDPOINT`, `S3_ACCESS_KEY`, `S3_SECRET_KEY`, `S3_BUCKET`
- Безопасность: `JWT_SECRET`, `SESSION_SECRET`, `NEXTAUTH_SECRET` (если используется)
- Создать/обновить `.env.example` (без секретов)

## 3. База данных
- Проверить соединение: `/api/db-status`
- Применить необходимые миграции (скрипты из `scripts/migration/`)
- Сверить схему с `tests/database_schema.sql` и отчётом `database-state-report.md`
- Настроить коннект-пул (лимиты, таймауты) — уже реализовано в `lib/database/db-connection.ts`
- Включить метрики: проверить `performanceMonitor` и отчёты

## 4. Очистка мёртвого кода и хардкодов
- Удалить/исправить скрипты с хардкодом адресов/паролей
- Пройтись `depcheck` и `ts-prune` для поиска неиспользуемого кода
- Очистить неиспользуемые страницы/роуты (с предварительным бэкапом и тестами)

## 5. Линтинг и форматирование
- Консистентные правила ESLint/Prettier
- Включить строгий режим TypeScript (`tsconfig.json`) при необходимости
- Исправить предупреждения `unused-imports` и неиспользуемые переменные

## 6. Тестирование
- Юнит/интеграционные API-тесты: каталог `tests/api`, запуск `node tests/run-all-tests.js`
- Тест БД: `tests/database/`
- Интеграция: `tests/integration/`
- Производительность: `tests/performance/`
- Добавить GitHub Actions workflow (build + lint + tests + type-check)

## 7. Кэширование и производительность
- Верифицировать Redis-подключение `/api/redis-status`
- Пересмотреть TTL ключей и инвалидацию (`lib/cache/*`)
- Включить gzip/br (Next.js по умолчанию), проверить `next.config.mjs`
- Настроить HTTP заголовки кэша для статики

## 8. Безопасность
- CSP: проверка настроек изображений, запрет inline-скриптов
- Отключить опасные загрузки, валидация входных данных (zod, schema)
- Секреты только через env, никакого хардкода

## 9. CI/CD и мониторинг
- Добавить pipeline: install → build → lint → type-check → tests
- Добавить артефакты: отчёты покрытия, JUnit
- Здоровье: healthchecks `/api/health`, `/api/db-status`, `/api/cache-status`

## 10. Документация
- Обновить README: запуск, переменные окружения, тесты
- Добавить инструкции по бэкапу/restore

## 11. Ролл-аут
- Подготовить `.env.production`
- Выполнить `npm run build && npm run start`
- Протестировать основные пользовательские флоу

## 12. Пост-стабилизация
- Включить логирование и сбор метрик
- Регулярные бэкапы (cron), мониторинг отказов