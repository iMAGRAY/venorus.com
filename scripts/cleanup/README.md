# Database Cleanup Scripts

Эти скрипты предназначены для очистки устаревших данных в базе данных PostgreSQL проекта MEDSIP-PROTEZ.

## ⚠️ ВАЖНО: Всегда делайте резервную копию перед очисткой!

## Скрипты

### 1. backup-before-cleanup.js
Создает резервную копию таблиц, которые будут затронуты очисткой.

```bash
node scripts/cleanup/backup-before-cleanup.js
```

Создает:
- SQL дамп в папке `backups/`
- JSON файл с метаданными
- Скрипт для восстановления

### 2. cleanup-obsolete-data.js
Очищает устаревшие данные из базы данных.

```bash
# Сначала проверьте, что будет удалено (без изменений)
node scripts/cleanup/cleanup-obsolete-data.js --dry-run

# Выполнить очистку
node scripts/cleanup/cleanup-obsolete-data.js

# Подробный вывод
node scripts/cleanup/cleanup-obsolete-data.js --verbose
```

## Что очищается

1. **Старые сессии пользователей** (старше 30 дней)
2. **Осиротевшие характеристики товаров** (без связи с товаром)
3. **Осиротевшие характеристики вариантов** (без связи с вариантом)
4. **Неиспользуемые медиафайлы** (не привязанные к товарам)
5. **Пустые складские транзакции** (с количеством 0)
6. **Старые удаленные товары** (is_deleted=true, старше 90 дней)
7. **Осиротевшие связи тегов** (без товара или тега)
8. **Неиспользуемые значения характеристик** (не привязанные ни к чему)

## Процесс очистки

### Шаг 1: Резервное копирование
```bash
node scripts/cleanup/backup-before-cleanup.js
```

### Шаг 2: Проверка (Dry Run)
```bash
node scripts/cleanup/cleanup-obsolete-data.js --dry-run
```

### Шаг 3: Очистка
```bash
node scripts/cleanup/cleanup-obsolete-data.js
```

## Восстановление из резервной копии

Если что-то пошло не так, используйте созданный скрипт восстановления:

```bash
cd backups
bash restore-backup-[TIMESTAMP].sh
```

## Рекомендации

1. **Всегда** делайте резервную копию перед очисткой
2. **Всегда** сначала запускайте с флагом `--dry-run`
3. Выполняйте очистку в период низкой активности
4. После очистки проверьте работу приложения

## Потенциальные таблицы для ручной проверки

Скрипт также проверяет наличие таблиц с именами, содержащими:
- `_backup`
- `_old`
- `_temp`
- `_test`
- `_copy`
- `_bak`

Эти таблицы нужно проверить вручную перед удалением.